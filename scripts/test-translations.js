#!/usr/bin/env node

import puppeteer from 'puppeteer'

const BASE_URL = 'http://localhost:3000'
const LOCALES = ['en', 'es', 'zh', 'fr', 'am', 'pt']

// Expected translations for each locale
const expectedTranslations = {
  en: {
    headerTitle: 'Paste to QR Code',
    heroTitle: 'Paste to QR Code',
    heroSubtitle: 'Paste any text from your clipboard and get a QR code instantly. No typing, no complexity - just paste and generate.',
    placeholder: 'Paste any text from your clipboard to generate QR code...',
    pasteButton: 'Paste',
    copyButton: 'Copy',
    shareButton: 'Share',
    downloadButton: 'Download',
    publishButton: 'Publish'
  },
  es: {
    headerTitle: 'Pegar a C√≥digo QR',
    heroTitle: 'Pegar a C√≥digo QR',
    heroSubtitle: 'Pega cualquier texto de tu portapapeles y obt√©n un c√≥digo QR al instante. Sin escribir, sin complejidad - solo pega y genera.',
    placeholder: 'Pega cualquier texto de tu portapapeles para generar c√≥digo QR...',
    pasteButton: 'Pegar',
    copyButton: 'Copiar',
    shareButton: 'Compartir',
    downloadButton: 'Descargar',
    publishButton: 'Publicar'
  },
  zh: {
    headerTitle: 'Á≤òË¥¥Âà∞‰∫åÁª¥Á†Å',
    heroTitle: 'Á≤òË¥¥Âà∞‰∫åÁª¥Á†Å',
    heroSubtitle: '‰ªéÂâ™Ë¥¥ÊùøÁ≤òË¥¥‰ªª‰ΩïÊñáÊú¨ÔºåÁ´ãÂç≥Ëé∑Âæó‰∫åÁª¥Á†Å„ÄÇÊó†ÈúÄËæìÂÖ•ÔºåÊó†ÈúÄÂ§çÊùÇÊìç‰Ωú - Âè™ÈúÄÁ≤òË¥¥ÂíåÁîüÊàê„ÄÇ',
    placeholder: '‰ªéÂâ™Ë¥¥ÊùøÁ≤òË¥¥‰ªª‰ΩïÊñáÊú¨‰ª•ÁîüÊàê‰∫åÁª¥Á†Å...',
    pasteButton: 'Á≤òË¥¥',
    copyButton: 'Â§çÂà∂',
    shareButton: 'ÂàÜ‰∫´',
    downloadButton: '‰∏ãËΩΩ',
    publishButton: 'ÂèëÂ∏É'
  },
  fr: {
    headerTitle: 'Coller vers Code QR',
    heroTitle: 'Coller vers Code QR',
    heroSubtitle: 'Collez n\'importe quel texte de votre presse-papiers et obtenez un code QR instantan√©ment. Pas de frappe, pas de complexit√© - collez et g√©n√©rez.',
    placeholder: 'Collez n\'importe quel texte de votre presse-papiers pour g√©n√©rer un code QR...',
    pasteButton: 'Coller',
    copyButton: 'Copier',
    shareButton: 'Partager',
    downloadButton: 'T√©l√©charger',
    publishButton: 'Publier'
  },
  am: {
    headerTitle: '·àò·àà·å†·çç ·ãà·ã∞ QR ·äÆ·ãµ',
    heroTitle: '·àò·àà·å†·çç ·ãà·ã∞ QR ·äÆ·ãµ',
    heroSubtitle: '·ä®·âÖ·äï·å•·â• ·â¶·à≠·ãµ·ãé ·àõ·äï·äõ·ãç·äï·àù ·åΩ·àë·çç ·ã≠·àà·å•·çâ ·ä•·äì ·ãà·ã≤·ã´·ãç·äë QR ·äÆ·ãµ ·ã´·åç·äô·ç¢ ·ã®·àò·â∞·ã®·â• ·ä†·àµ·çà·àã·åä·äê·âµ ·ã®·àà·àù·ç£ ·ãç·àµ·â•·àµ·â•·äê·âµ ·ã®·àà·àù - ·â•·âª ·ã≠·àà·å•·çâ ·ä•·äì ·ã≠·çç·å†·à©·ç¢',
    placeholder: 'QR ·äÆ·ãµ ·àà·àò·çç·å†·à≠ ·ä®·âÖ·äï·å•·â• ·â¶·à≠·ãµ·ãé ·àõ·äï·äõ·ãç·äï·àù ·åΩ·àë·çç ·ã≠·àà·å•·çâ...',
    pasteButton: '·àò·àà·å†·çç',
    copyButton: '·àò·âÖ·ã≥·âµ',
    shareButton: '·àò·åã·à´·âµ',
    downloadButton: '·àò·à∏·åã·åà·à≠',
    publishButton: '·àò·â∞·àã·àà·çç'
  },
  pt: {
    headerTitle: 'Colar para C√≥digo QR',
    heroTitle: 'Colar para C√≥digo QR',
    heroSubtitle: 'Cole qualquer texto da sua √°rea de transfer√™ncia e obtenha um c√≥digo QR instantaneamente. Sem digita√ß√£o, sem complexidade - apenas cole e gere.',
    placeholder: 'Cole qualquer texto da sua √°rea de transfer√™ncia para gerar c√≥digo QR...',
    pasteButton: 'Colar',
    copyButton: 'Copiar',
    shareButton: 'Compartilhar',
    downloadButton: 'Baixar',
    publishButton: 'Publicar'
  }
}

// Test results storage
const translationResults = {}

// Test translations for a specific locale
async function testTranslations(page, locale) {
  console.log(`\nüîç Testing translations for ${locale}...`)
  
  const url = locale === 'en' ? BASE_URL : `${BASE_URL}/${locale}`
  await page.goto(url, { waitUntil: 'networkidle0' })
  
  // Wait for page to load and translations to be applied
  await new Promise(resolve => setTimeout(resolve, 3000))
  
  const results = {
    passed: 0,
    failed: 0,
    tests: []
  }
  
  const expected = expectedTranslations[locale]
  
  try {
    // Test header title
    const headerTitle = await page.$eval('h1', el => el.textContent.trim())
    const headerTest = {
      key: 'headerTitle',
      expected: expected.headerTitle,
      actual: headerTitle,
      passed: headerTitle === expected.headerTitle
    }
    results.tests.push(headerTest)
    if (headerTest.passed) results.passed++
    else results.failed++
    
    // Test hero title
    const heroTitle = await page.$eval('h2', el => el.textContent.trim())
    const heroTest = {
      key: 'heroTitle',
      expected: expected.heroTitle,
      actual: heroTitle,
      passed: heroTitle === expected.heroTitle
    }
    results.tests.push(heroTest)
    if (heroTest.passed) results.passed++
    else results.failed++
    
    // Test hero subtitle
    const heroSubtitle = await page.$eval('p', el => el.textContent.trim())
    const subtitleTest = {
      key: 'heroSubtitle',
      expected: expected.heroSubtitle,
      actual: heroSubtitle,
      passed: heroSubtitle === expected.heroSubtitle
    }
    results.tests.push(subtitleTest)
    if (subtitleTest.passed) results.passed++
    else results.failed++
    
    // Test placeholder text
    const placeholder = await page.$eval('textarea', el => el.placeholder)
    const placeholderTest = {
      key: 'placeholder',
      expected: expected.placeholder,
      actual: placeholder,
      passed: placeholder === expected.placeholder
    }
    results.tests.push(placeholderTest)
    if (placeholderTest.passed) results.passed++
    else results.failed++
    
    // Test button texts
    const buttons = await page.$$eval('button', els => els.map(el => el.textContent.trim()))
    
    // Test paste button
    const pasteButton = buttons.find(btn => btn.includes('Paste') || btn.includes('Pegar') || btn.includes('Á≤òË¥¥') || btn.includes('Coller') || btn.includes('·àò·àà·å†·çç') || btn.includes('Colar'))
    const pasteTest = {
      key: 'pasteButton',
      expected: expected.pasteButton,
      actual: pasteButton || 'Not found',
      passed: pasteButton === expected.pasteButton
    }
    results.tests.push(pasteTest)
    if (pasteTest.passed) results.passed++
    else results.failed++
    
    // Test language switcher
    const languageButton = await page.$eval('[data-testid="language-switcher"] button', el => el.textContent.trim())
    const languageTest = {
      key: 'languageButton',
      expected: 'Language',
      actual: languageButton,
      passed: languageButton === 'Language' || languageButton === 'Idioma' || languageButton === 'ËØ≠Ë®Ä' || languageButton === 'Langue' || languageButton === '·âã·äï·âã' || languageButton === 'Idioma'
    }
    results.tests.push(languageTest)
    if (languageTest.passed) results.passed++
    else results.failed++
    
    console.log(`‚úÖ Translation tests for ${locale}: ${results.passed}/${results.passed + results.failed} passed`)
    
    // Log failed tests
    results.tests.filter(test => !test.passed).forEach(test => {
      console.log(`‚ùå ${test.key}: Expected "${test.expected}", got "${test.actual}"`)
    })
    
    translationResults[locale] = results
    
  } catch (error) {
    console.error(`‚ùå Translation test failed for ${locale}:`, error.message)
    translationResults[locale] = { error: error.message }
  }
}

// Test language switching
async function testLanguageSwitching(page) {
  console.log(`\nüîÑ Testing language switching...`)
  
  const results = {
    passed: 0,
    failed: 0,
    tests: []
  }
  
  try {
    // Start on English page
    await page.goto(BASE_URL, { waitUntil: 'networkidle0' })
    await new Promise(resolve => setTimeout(resolve, 2000))
    
    // Get initial language
    const initialTitle = await page.$eval('h1', el => el.textContent.trim())
    const initialTest = {
      key: 'initialLanguage',
      expected: 'Paste to QR Code',
      actual: initialTitle,
      passed: initialTitle === 'Paste to QR Code'
    }
    results.tests.push(initialTest)
    if (initialTest.passed) results.passed++
    else results.failed++
    
    // Switch to Spanish
    await page.click('[data-testid="language-switcher"] button')
    await new Promise(resolve => setTimeout(resolve, 1000))
    
    // Click on Spanish option
    const spanishOption = await page.$('button:has-text("üá™üá∏")')
    if (spanishOption) {
      await spanishOption.click()
      await new Promise(resolve => setTimeout(resolve, 2000))
      
      const spanishTitle = await page.$eval('h1', el => el.textContent.trim())
      const spanishTest = {
        key: 'spanishSwitch',
        expected: 'Pegar a C√≥digo QR',
        actual: spanishTitle,
        passed: spanishTitle === 'Pegar a C√≥digo QR'
      }
      results.tests.push(spanishTest)
      if (spanishTest.passed) results.passed++
      else results.failed++
    }
    
    // Switch to Chinese
    await page.click('[data-testid="language-switcher"] button')
    await new Promise(resolve => setTimeout(resolve, 1000))
    
    const chineseOption = await page.$('button:has-text("üá®üá≥")')
    if (chineseOption) {
      await chineseOption.click()
      await new Promise(resolve => setTimeout(resolve, 2000))
      
      const chineseTitle = await page.$eval('h1', el => el.textContent.trim())
      const chineseTest = {
        key: 'chineseSwitch',
        expected: 'Á≤òË¥¥Âà∞‰∫åÁª¥Á†Å',
        actual: chineseTitle,
        passed: chineseTitle === 'Á≤òË¥¥Âà∞‰∫åÁª¥Á†Å'
      }
      results.tests.push(chineseTest)
      if (chineseTest.passed) results.passed++
      else results.failed++
    }
    
    console.log(`‚úÖ Language switching tests: ${results.passed}/${results.passed + results.failed} passed`)
    
    // Log failed tests
    results.tests.filter(test => !test.passed).forEach(test => {
      console.log(`‚ùå ${test.key}: Expected "${test.expected}", got "${test.actual}"`)
    })
    
    translationResults['languageSwitching'] = results
    
  } catch (error) {
    console.error(`‚ùå Language switching test failed:`, error.message)
    translationResults['languageSwitching'] = { error: error.message }
  }
}

// Main test function
async function runTranslationTests() {
  console.log('üöÄ Starting translation tests...')
  
  const browser = await puppeteer.launch({
    headless: false,
    defaultViewport: { width: 1280, height: 720 },
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  })
  
  const page = await browser.newPage()
  
  // Enable console logging
  page.on('console', msg => {
    if (msg.type() === 'error') {
      console.log('‚ùå Browser Error:', msg.text())
    }
  })
  
  // Run translation tests for each locale
  for (const locale of LOCALES) {
    await testTranslations(page, locale)
    await new Promise(resolve => setTimeout(resolve, 1000))
  }
  
  // Test language switching
  await testLanguageSwitching(page)
  
  await browser.close()
  
  // Generate test report
  console.log('\nüìä TRANSLATION TEST RESULTS:')
  console.log('=' * 50)
  
  // Translation summary
  console.log('\nüîç TRANSLATIONS:')
  Object.entries(translationResults).forEach(([locale, result]) => {
    if (result.error) {
      console.log(`‚ùå ${locale}: ${result.error}`)
    } else {
      console.log(`‚úÖ ${locale}: ${result.passed}/${result.passed + result.failed} tests passed`)
    }
  })
  
  // Overall assessment
  const totalTests = Object.values(translationResults)
    .filter(r => !r.error)
    .reduce((sum, r) => sum + r.passed + r.failed, 0)
  
  const passedTests = Object.values(translationResults)
    .filter(r => !r.error)
    .reduce((sum, r) => sum + r.passed, 0)
  
  console.log(`\nüéØ OVERALL RESULT: ${passedTests}/${totalTests} translation tests passed`)
  
  if (passedTests === totalTests) {
    console.log('üéâ ALL TRANSLATION TESTS PASSED!')
  } else {
    console.log('‚ö†Ô∏è  Some translation tests failed. Check the details above.')
  }
  
  // Recommendations
  console.log('\nüí° TRANSLATION RECOMMENDATIONS:')
  const failedLocales = Object.entries(translationResults)
    .filter(([locale, result]) => !result.error && result.failed > 0)
    .map(([locale]) => locale)
  
  if (failedLocales.length > 0) {
    console.log(`‚ö†Ô∏è  Review translations for: ${failedLocales.join(', ')}`)
  } else {
    console.log('üéâ All translations are working correctly!')
  }
}

// Run tests
runTranslationTests().catch(console.error)